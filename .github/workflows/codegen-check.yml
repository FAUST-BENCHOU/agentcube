name: Code Generation Check

on:
  pull_request:
    branches:
      - main
      - 'release-*'
    paths:
      - 'pkg/apis/**'
      - 'crds/**'
      - 'client-go/**'
      - 'hack/**'
      - 'Makefile'
      - 'go.mod'
      - 'go.sum'
      - '.github/workflows/codegen-check.yml'

permissions:
  contents: read
  pull-requests: read

jobs:
  check-codegen:
    name: Check CRD and client-go generation
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for git diff

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install dependencies
        run: |
          go mod download
          go mod tidy

      - name: Install controller-gen
        run: make controller-gen

      - name: Check CRD and client-go generation
        run: |
          # Generate CRD
          make gen-crd
          
          # Generate client-go
          make gen-client
          
          # Check CRD and client-go files
          ret=0
          if git diff --name-only | grep -q "^crds/"; then
            echo "::error::CRD files are out of date!"
            ret=1
          fi
          if git diff --name-only | grep -q "^client-go/"; then
            echo "::error::client-go files are out of date!"
            ret=1
          fi
          
          if [ $ret -ne 0 ]; then
            echo "Generated code is out of date!"
            echo ""
            echo "The following files have been modified:"
            git status --porcelain | grep -E "^(crds|client-go)/" || true
            echo ""
            echo "Diff of changes:"
            git diff -- crds/ client-go/ || true
            echo ""
            echo "Please run 'make gen-crd' and 'make gen-client' and commit the changes."
            exit 1
          fi
          echo "All generated code (CRD and client-go) is up to date!"

